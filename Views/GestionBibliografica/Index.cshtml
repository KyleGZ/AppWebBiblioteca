@{
    Layout = "_Layout";
    ViewData["Title"] = "Gestión Bibliográfica";
    ViewData["PageTitle"] = "Gestión Bibliográfica";

    string activeTab = (Context.Request.Query["tab"].ToString() ?? string.Empty).ToLowerInvariant();
    if (string.IsNullOrWhiteSpace(activeTab)) activeTab = "editoriales"; // pestaña por defecto

    bool isAutores = activeTab == "autores";
    bool isEditoriales = activeTab == "editoriales";
    bool isGeneros = activeTab == "generos";
    bool isSecciones = activeTab == "secciones";
}

@section Styles {
    <link rel="stylesheet" href="~/css/StyleGestionBibliografica.css" />
}

<div class="container-fluid p-4">
    <div class="row justify-content-center gb-fade-in">
        <div class="col-12">
            <div class="card gb-card">
                <div class="card-body p-4">
                    <!-- Header visual (sin tocar funcionalidad) -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h2 class="mb-1">
                                <i class="fas fa-swatchbook me-2 gb-title-icon"></i>
                                Gestión Bibliográfica
                            </h2>
                            <p class="text-muted mb-0">Administra editoriales, autores, géneros y secciones del catálogo</p>
                        </div>
                        <div class="d-flex gap-2">
                            <a class="btn btn-outline-secondary btn-sm" asp-controller="Libro" asp-action="Index">
                                <i class="fas fa-book me-1"></i> Ir al Catálogo de Libros
                            </a>
                        </div>
                    </div>

                    <!-- Tabs (mismos ids/atributos; solo clases extra para estilo) -->
                    <ul class="nav nav-tabs gb-tabs" id="slTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link gb-tab @(isEditoriales ? "active" : "")"
                                    id="tab-editoriales"
                                    data-bs-toggle="tab"
                                    data-bs-target="#pane-editoriales"
                                    type="button" role="tab"
                                    aria-controls="pane-editoriales"
                                    aria-selected="@(isEditoriales ? "true" : "false")"
                                    data-tabkey="editoriales">
                                <i class="fas fa-building me-1"></i>Editoriales
                            </button>
                        </li>

                        <li class="nav-item" role="presentation">
                            <button class="nav-link gb-tab @(isAutores ? "active" : "")"
                                    id="tab-autores"
                                    data-bs-toggle="tab"
                                    data-bs-target="#pane-autores"
                                    type="button" role="tab"
                                    aria-controls="pane-autores"
                                    aria-selected="@(isAutores ? "true" : "false")"
                                    data-tabkey="autores">
                                <i class="fas fa-feather-alt me-1"></i>Autores
                            </button>
                        </li>

                        <li class="nav-item" role="presentation">
                            <button class="nav-link gb-tab @(isGeneros ? "active" : "")"
                                    id="tab-generos"
                                    data-bs-toggle="tab"
                                    data-bs-target="#pane-generos"
                                    type="button" role="tab"
                                    aria-controls="pane-generos"
                                    aria-selected="@(isGeneros ? "true" : "false")"
                                    data-tabkey="generos">
                                <i class="fas fa-tag me-1"></i>Géneros
                            </button>
                        </li>

                        <li class="nav-item" role="presentation">
                            <button class="nav-link gb-tab @(isSecciones ? "active" : "")"
                                    id="tab-secciones"
                                    data-bs-toggle="tab"
                                    data-bs-target="#pane-secciones"
                                    type="button" role="tab"
                                    aria-controls="pane-secciones"
                                    aria-selected="@(isSecciones ? "true" : "false")"
                                    data-tabkey="secciones">
                                <i class="fas fa-layer-group me-1"></i>Secciones
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content pt-3">
                        <!-- Editoriales -->
                        <div class="tab-pane fade @(isEditoriales ? "show active" : "")"
                             id="pane-editoriales" role="tabpanel" aria-labelledby="tab-editoriales">
                            <div id="tabEditoriales"
                                 data-url-default="@Url.Action("Tab", "Editorial", new { termino = "", pagina = 1, resultadosPorPagina = 20 })">
                                <div class="text-center text-muted py-5" id="editorialesLoading">
                                    <div class="spinner-border" role="status"><span class="visually-hidden">Cargando…</span></div>
                                    <div class="mt-2">Cargando editoriales…</div>
                                </div>
                            </div>
                        </div>

                        <!-- Autores -->
                        <div class="tab-pane fade @(isAutores ? "show active" : "")"
                             id="pane-autores" role="tabpanel" aria-labelledby="tab-autores">
                            <div id="tabAutores"
                                 data-url-default="@Url.Action("Tab", "Autor", new { termino = "", pagina = 1, resultadosPorPagina = 20 })">
                                <div class="text-center text-muted py-5" id="autoresLoading">
                                    <div class="spinner-border" role="status"><span class="visually-hidden">Cargando…</span></div>
                                    <div class="mt-2">Cargando autores…</div>
                                </div>
                            </div>
                        </div>

                        <!-- Géneros -->
                        <div class="tab-pane fade @(isGeneros ? "show active" : "")"
                             id="pane-generos" role="tabpanel" aria-labelledby="tab-generos">
                            <div id="tabGeneros"
                                 data-url-default="@Url.Action("Tab", "Genero", new { termino = "", pagina = 1, resultadosPorPagina = 20 })">
                                <div class="text-center text-muted py-5" id="generosLoading">
                                    <div class="spinner-border" role="status"><span class="visually-hidden">Cargando…</span></div>
                                    <div class="mt-2">Cargando géneros…</div>
                                </div>
                            </div>
                        </div>

                        <!-- Secciones -->
                        <div class="tab-pane fade @(isSecciones ? "show active" : "")"
                             id="pane-secciones" role="tabpanel" aria-labelledby="tab-secciones">
                            <div id="tabSecciones"
                                 data-url-default="@Url.Action("Tab", "Seccion", new { termino = "", pagina = 1, resultadosPorPagina = 20 })">
                                <div class="text-center text-muted py-5" id="seccionesLoading">
                                    <div class="spinner-border" role="status"><span class="visually-hidden">Cargando…</span></div>
                                    <div class="mt-2">Cargando secciones…</div>
                                </div>
                            </div>
                        </div>
                    </div> <!-- /tab-content -->
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (() => {
          // ---------- Util ----------
          async function loadInto(host, url){
            if(!host || !url) return;
            try{
              host.dataset.urlCurrent = url;
              const res = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
              const html = await res.text();
              if(!res.ok){
                console.error('HTTP ' + res.status, html);
                host.innerHTML = `<div class="alert alert-danger">Error al cargar (HTTP ${res.status}).</div>`;
                return;
              }
              host.innerHTML = html;
            }catch(err){
              console.error(err);
              host.innerHTML = `<div class="alert alert-danger">No se pudo cargar el contenido.</div>`;
            }
          }

          // ---------- Función mejorada para mostrar mensajes ----------
          function showOperationResult(result) {
            if (result.success) {
              showSuccess(result.message);
            } else {
              showError(result.message);
            }
          }

          // ---------- Cablear cada contenedor de pestaña ----------
          function wireTabHost(host){
            if(!host) return;

            // Buscar (GET) + CRUD (POST)
            host.addEventListener('submit', (e) => {
              const form = e.target;
              if(!form) return;

              const action = (form.getAttribute('action') || '').toLowerCase();
              const isPost = (form.method || 'get').toLowerCase() === 'post';

              // Buscar (formularios cuyo id empieza por "searchForm")
              if(form.id && form.id.startsWith('searchForm')){
                e.preventDefault();
                const qs = new URLSearchParams(new FormData(form)).toString();
                loadInto(host, form.action + '?' + qs);
                return;
              }

              // Crear / Editar / Eliminar (POST) - USANDO MODAL GLOBAL
              const isCrud = action.endsWith('/crear') || action.endsWith('/editar') || action.endsWith('/eliminar');
              if(isCrud && isPost){
                e.preventDefault();

                fetch(action, {
                  method: 'POST',
                  body: new FormData(form),
                  headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                  }
                })
                .then(async (response) => {
                  let result;
                  try {
                    result = await response.json();
                  } catch (jsonError) {
                    console.error('Error parsing JSON:', jsonError);
                    showError('Error en la respuesta del servidor');
                    return;
                  }

                  // Usar el modal global en lugar de notificaciones
                  showOperationResult(result);

                  // Recargar el contenido de la pestaña si fue exitoso
                  if (result.success) {
                    const urlToReload = host.dataset.urlCurrent || host.dataset.urlDefault;
                    if(urlToReload) {
                      await loadInto(host, urlToReload);
                    }
                  }

                  // Cerrar el modal del formulario
                  const modalEl = form.closest('.modal');
                  if(modalEl && window.bootstrap){
                    const modalInstance = bootstrap.Modal.getInstance(modalEl);
                    if (modalInstance) {
                      modalInstance.hide();
                    }
                  }
                })
                .catch(err => {
                  console.error('Fetch error:', err);
                  showError('Ocurrió un error procesando la acción.');
                });
              }
            });
            host.addEventListener('click', (e) => {
              const btn = e.target.closest('.js-page');
              if(!btn) return;
              e.preventDefault();

              const form = host.querySelector('form[id^="searchForm"]');
              if(!form) return;

              const pagina = btn.getAttribute('data-page');
              const paginaHidden = form.querySelector('input[name="pagina"]');
              if(paginaHidden) paginaHidden.value = pagina;

              const qs = new URLSearchParams(new FormData(form)).toString();
              loadInto(host, form.action + '?' + qs);
            });

            host.addEventListener('change', (e) => {
              const sel = e.target;
              if(sel && sel.name === 'resultadosPorPagina'){
                const form = host.querySelector('form[id^="searchForm"]');
                if(!form) return;

                const paginaHidden = form.querySelector('input[name="pagina"]');
                if(paginaHidden) paginaHidden.value = 1;

                const qs = new URLSearchParams(new FormData(form)).toString();
                loadInto(host, form.action + '?' + qs);
              }
            });

            host.addEventListener('click', (e) => {
              const btnEdit = e.target.closest('[data-bs-target^="#modalEditar"]');
              if(btnEdit){
                const target = btnEdit.getAttribute('data-bs-target');
                const modal  = document.querySelector(target);
                if(modal){
                  const id  = btnEdit.getAttribute('data-id') || '';
                  const nom = btnEdit.getAttribute('data-nombre') || '';
                  const ubi = btnEdit.getAttribute('data-ubicacion') || '';

                  if(target === '#modalEditarEditorial'){
                    const idI = modal.querySelector('#editarIdEditorial');
                    const nI  = modal.querySelector('#editarNombreEditorial');
                    if(idI) idI.value = id; if(nI) nI.value = nom;
                  }else if(target === '#modalEditarAutor'){
                    const idI = modal.querySelector('#editarIdAutor');
                    const nI  = modal.querySelector('#editarNombreAutor');
                    if(idI) idI.value = id; if(nI) nI.value = nom;
                  }else if(target === '#modalEditarGenero'){
                    const idI = modal.querySelector('#editarIdGenero');
                    const nI  = modal.querySelector('#editarNombreGenero');
                    if(idI) idI.value = id; if(nI) nI.value = nom;
                  }else if(target === '#modalEditarSeccion'){
                    const idI = modal.querySelector('#editarIdSeccion');
                    const nI  = modal.querySelector('#editarNombreSeccion');
                    const uI  = modal.querySelector('#editarUbicacionSeccion');
                    if(idI) idI.value = id; if(nI) nI.value = nom; if(uI) uI.value = ubi;
                  }
                }
              }

              const btnDel = e.target.closest('[data-bs-target^="#modalEliminar"]');
              if(btnDel){
                const target = btnDel.getAttribute('data-bs-target');
                const modal  = document.querySelector(target);
                if(modal){
                  const id  = btnDel.getAttribute('data-id') || '';
                  const nom = btnDel.getAttribute('data-nombre') || '';

                  if(target === '#modalEliminarEditorial'){
                    const idI = modal.querySelector('#eliminarIdEditorial');
                    const lI  = modal.querySelector('#nombreEditorialEliminar');
                    if(idI) idI.value = id; if(lI) lI.textContent = nom;
                  }else if(target === '#modalEliminarAutor'){
                    const idI = modal.querySelector('#eliminarIdAutor');
                    const lI  = modal.querySelector('#nombreAutorEliminar');
                    if(idI) idI.value = id; if(lI) lI.textContent = nom;
                  }else if(target === '#modalEliminarGenero'){
                    const idI = modal.querySelector('#eliminarIdGenero');
                    const lI  = modal.querySelector('#nombreGeneroEliminar');
                    if(idI) idI.value = id; if(lI) lI.textContent = nom;
                  }else if(target === '#modalEliminarSeccion'){
                    const idI = modal.querySelector('#eliminarIdSeccion');
                    const lI  = modal.querySelector('#nombreSeccionEliminar');
                    if(idI) idI.value = id; if(lI) lI.textContent = nom;
                  }
                }
              }
            });
          }

          // ---------- Referencias y inicialización ----------
          const hostEd = document.getElementById('tabEditoriales');
          const hostAu = document.getElementById('tabAutores');
          const hostGe = document.getElementById('tabGeneros');
          const hostSe = document.getElementById('tabSecciones');

          [hostEd, hostAu, hostGe, hostSe].forEach(wireTabHost);

          // [Mantener el resto del código de inicialización igual]
          document.addEventListener('DOMContentLoaded', () => {
            const activeBtn = document.querySelector('#slTabs .nav-link.active');
            const key = activeBtn ? (activeBtn.getAttribute('data-tabkey') || '').toLowerCase() : '';
            const map = { editoriales: hostEd, autores: hostAu, generos: hostGe, secciones: hostSe };
            const host = map[key];
            if(host && host.dataset && host.dataset.urlDefault){
              loadInto(host, host.dataset.urlDefault);
            }
          });

          document.addEventListener('shown.bs.tab', (ev) => {
            const key = (ev.target && ev.target.getAttribute('data-tabkey')) || '';
            const map = { editoriales: hostEd, autores: hostAu, generos: hostGe, secciones: hostSe };
            const loadingId = {
              editoriales: '#editorialesLoading',
              autores:     '#autoresLoading',
              generos:     '#generosLoading',
              secciones:   '#seccionesLoading'
            }[key];

            const host = map[key];
            if(host && host.dataset && host.dataset.urlDefault){
              if(!loadingId || host.querySelector(loadingId)){
                loadInto(host, host.dataset.urlDefault);
              }
            }
          });
        })();
    </script>
}