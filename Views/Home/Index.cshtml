@{
    Layout = "_Layout";
    ViewData["Title"] = "Inicio - Biblioteca Pública de Esparza";
    ViewData["PageTitle"] = "Dashboard Biblioteca";
    var userEmail = ViewBag.UserEmail as string;
    var userRoles = ViewBag.UserRoles as List<string> ?? new List<string>();
    var estadisticas = ViewBag.Estadisticas as AppWebBiblioteca.Models.EstadisticasPrestamosDTO;
}

<!-- Contenido específico de Home -->
<div class="container-fluid p-3 p-md-4">
    <!-- Mensaje de bienvenida -->
    <div class="row justify-content-center fade-in">
        <div class="col-12 col-xxl-10">
            <div class="card main-card">
                <div class="card-body p-3 p-md-4">
                    <div class="alert alert-library border-0 mb-4">
                        <h4 class="alert-heading h5 h4-md">
                            <i class="fas fa-book-reader me-2"></i>¡Bienvenido al Sistema Bibliotecario!
                        </h4>
                        <p class="mb-0 small small-md">Biblioteca Pública de Esparza - Sistema integrado de gestión bibliotecaria</p>
                    </div>

                    <!-- Filtros y controles -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title h6 h5-md">
                                        <i class="fas fa-filter me-2"></i>
                                        Filtros de Estadísticas
                                    </h5>
                                    <form id="filtroForm" class="row g-3 align-items-end">
                                        <div class="col-md-3">
                                            <label for="fechaInicio" class="form-label small">Fecha Inicio</label>
                                            <input type="date" class="form-control form-control-sm" id="fechaInicio"
                                                   value="@DateTime.Now.ToString("yyyy-MM-01")">
                                        </div>
                                        <div class="col-md-3">
                                            <label for="fechaFin" class="form-label small">Fecha Fin</label>
                                            <input type="date" class="form-control form-control-sm" id="fechaFin"
                                                   value="@DateTime.Now.ToString("yyyy-MM-dd")">
                                        </div>
                                        <div class="col-md-6">
                                            <button type="button" id="btnFiltrar" class="btn btn-esparza-primary btn-sm">
                                                <i class="fas fa-search me-1"></i>Filtrar
                                            </button>
                                            <button type="button" id="btnDescargar" class="btn btn-success btn-sm">
                                                <i class="fas fa-file-excel me-1"></i>Descargar Excel
                                            </button>
                                            <button type="button" id="btnReset" class="btn btn-outline-secondary btn-sm">
                                                <i class="fas fa-sync me-1"></i>Reset
                                            </button>
                                        </div>
                                    </form>
                                    
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Estadísticas rápidas ACTUALIZADAS -->
                    <div id="estadisticasContainer">
                        @await Html.PartialAsync("_EstadisticasPartial", estadisticas)
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar gráficos con datos iniciales
            const estadisticas = @Html.Raw(Json.Serialize(estadisticas));
            if (estadisticas) {
                crearGraficos(estadisticas);
            }

            // Evento para filtrar
            document.getElementById('btnFiltrar').addEventListener('click', filtrarEstadisticas);

            // Evento para descargar Excel
            document.getElementById('btnDescargar').addEventListener('click', descargarExcel);

            // Evento para reset
            document.getElementById('btnReset').addEventListener('click', resetFiltros);

            // Enter en los filtros también ejecuta la búsqueda
            document.getElementById('fechaInicio').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') filtrarEstadisticas();
            });
            document.getElementById('fechaFin').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') filtrarEstadisticas();
            });
        });

        async function filtrarEstadisticas() {
            const fechaInicio = document.getElementById('fechaInicio').value;
            const fechaFin = document.getElementById('fechaFin').value;

            try {
                const formData = new FormData();
                formData.append('fechaInicio', fechaInicio);
                formData.append('fechaFin', fechaFin);

                const response = await fetch('/Home/FiltrarEstadisticas', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    }
                });

                if (response.ok) {
                    const html = await response.text();
                    document.getElementById('estadisticasContainer').innerHTML = html;

                    // Extraer datos del HTML para los gráficos
                    const estadisticasScript = document.getElementById('estadisticasData');
                    if (estadisticasScript) {
                        const estadisticas = JSON.parse(estadisticasScript.textContent);
                        crearGraficos(estadisticas);
                    }
                } else {
                    alert('Error al filtrar estadísticas');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al filtrar estadísticas');
            }
        }

        async function descargarExcel() {
            const fechaInicio = document.getElementById('fechaInicio').value;
            const fechaFin = document.getElementById('fechaFin').value;

            try {
                const formData = new FormData();
                formData.append('fechaInicio', fechaInicio);
                formData.append('fechaFin', fechaFin);

                const response = await fetch('/Home/DescargarReporte', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    }
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = `ReportePrestamos_${new Date().toISOString().slice(0,16).replace(/[-T:]/g,'')}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                } else {
                    alert('Error al descargar el reporte');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al descargar el reporte');
            }
        }

        function resetFiltros() {
            const firstDay = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
            const today = new Date();

            document.getElementById('fechaInicio').value = firstDay.toISOString().split('T')[0];
            document.getElementById('fechaFin').value = today.toISOString().split('T')[0];

            filtrarEstadisticas();
        }

        function crearGraficos(estadisticas) {
            crearGraficoEstadoLibros(estadisticas);
            crearGraficoPrestamosDia(estadisticas.prestamosPorDia);
        }

        function crearGraficoEstadoLibros(data) {
            const ctx = document.getElementById('estadoLibrosChart');
            if (!ctx) return;

            // Destruir gráfico existente
            if (window.estadoLibrosChartInstance) {
                window.estadoLibrosChartInstance.destroy();
            }

            window.estadoLibrosChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Disponibles', 'Prestados'],
                    datasets: [{
                        data: [data.librosDisponibles, data.librosPrestados],
                        backgroundColor: ['#4BC0C0', '#FF6384'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function crearGraficoPrestamosDia(datosPorDia) {
            const ctx = document.getElementById('prestamosDiaChart');
            if (!ctx) return;

            // Destruir gráfico existente
            if (window.prestamosDiaChartInstance) {
                window.prestamosDiaChartInstance.destroy();
            }

            window.prestamosDiaChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: datosPorDia.map(d => d.fecha),
                    datasets: [{
                        label: 'Préstamos por Día',
                        data: datosPorDia.map(d => d.cantidad),
                        borderColor: '#36A2EB',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }
    </script>
}