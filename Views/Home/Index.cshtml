@{
    Layout = "_Layout";
    ViewData["Title"] = "Inicio - Biblioteca Pública de Esparza";
    ViewData["PageTitle"] = "Dashboard Biblioteca";
    var userEmail = ViewBag.UserEmail as string;
    var userRoles = ViewBag.UserRoles as List<string> ?? new List<string>();
    var estadisticas = ViewBag.Estadisticas as AppWebBiblioteca.Models.EstadisticasPrestamosDTO;
}

<!-- Contenido específico de Home -->
<div class="container-fluid p-3 p-md-4">
    <!-- Mensaje de bienvenida -->
    <div class="row justify-content-center fade-in">
        <div class="col-12 col-xxl-10">
            <div class="card main-card">
                <div class="card-body p-3 p-md-4">
                    <div class="alert alert-library border-0 mb-4">
                        <h4 class="alert-heading h5 h4-md">
                            <i class="fas fa-book-reader me-2"></i>¡Bienvenido al Sistema Bibliotecario!
                        </h4>
                        <p class="mb-0 small small-md">Biblioteca Pública de Esparza - Sistema integrado de gestión bibliotecaria</p>
                    </div>

                    <!-- Estadísticas rápidas ACTUALIZADAS -->
                    <div class="row mb-4 g-2 g-md-3">
                        <div class="col-6 col-md-3">
                            <div class="stats-card text-center h-100">
                                <div class="stats-number" id="librosDisponibles">@(estadisticas?.LibrosDisponibles ?? 0)</div>
                                <div class="stats-label">Libros Disponibles</div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="stats-card text-center h-100">
                                <div class="stats-number" id="prestamosActivos">@(estadisticas?.PrestamosActivos ?? 0)</div>
                                <div class="stats-label">Préstamos Activos</div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="stats-card text-center h-100">
                                <div class="stats-number" id="prestamosMes">@(estadisticas?.PrestamosMes ?? 0)</div>
                                <div class="stats-label">Préstamos del Mes</div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="stats-card text-center h-100">
                                <div class="stats-number" id="prestamosDevueltos">@(estadisticas?.PrestamosDevueltos ?? 0)</div>
                                <div class="stats-label">Devueltos del Mes</div>
                            </div>
                        </div>
                    </div>

                    <!-- Información del usuario -->
                    <div class="row mb-4 g-3">
                        <div class="col-12 col-lg-6">
                            <div class="card feature-card library h-100">
                                <div class="card-body">
                                    <h5 class="card-title h6 h5-md">
                                        <i class="fas fa-user-circle me-2 user-icon"></i>
                                        Información del Bibliotecario
                                    </h5>
                                    <p class="mb-1 small small-md"><strong>Email:</strong> @userEmail</p>
                                    <p class="mb-1 small small-md"><strong>Roles:</strong> @string.Join(", ", userRoles)</p>
                                    <p class="mb-0 small small-md"><strong>Último acceso:</strong> @DateTime.Now.ToString("dd/MM/yyyy HH:mm")</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-lg-6">
                            <div class="card feature-card users h-100">
                                <div class="card-body">
                                    <h5 class="card-title h6 h5-md">
                                        <i class="fas fa-chart-line me-2 book-icon"></i>
                                        Estado del Sistema
                                    </h5>
                                    <p class="mb-1 small small-md">
                                        <i class="fas fa-circle text-success me-2"></i>
                                        Libros disponibles: @(estadisticas?.LibrosDisponibles ?? 0)
                                    </p>
                                    <p class="mb-1 small small-md">
                                        <i class="fas fa-circle text-warning me-2"></i>
                                        Préstamos activos: @(estadisticas?.PrestamosActivos ?? 0)
                                    </p>
                                    <p class="mb-0 small small-md">
                                        <i class="fas fa-circle text-info me-2"></i>
                                        Préstamos este mes: @(estadisticas?.PrestamosMes ?? 0)
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Gráficos de estadísticas -->
                    <div class="row mb-4 g-3">
                        <div class="col-12 col-lg-6">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h5 class="card-title h6 h5-md">
                                        <i class="fas fa-chart-pie me-2"></i>
                                        Distribución de Libros
                                    </h5>
                                    <div class="chart-container" style="height: 200px;">
                                        <canvas id="estadoLibrosChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-lg-6">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h5 class="card-title h6 h5-md">
                                        <i class="fas fa-chart-bar me-2"></i>
                                        Préstamos por Día (Este Mes)
                                    </h5>
                                    <div class="chart-container" style="height: 200px;">
                                        <canvas id="prestamosDiaChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Botones de acción -->
                    <div class="row">
                        <div class="col-12">
                            <h5 class="mb-3 h6 h5-md text-center">
                                <i class="fas fa-bolt me-2 text-warning"></i>
                                Acciones Rápidas
                            </h5>
                            <div class="d-flex flex-wrap gap-2 justify-content-center align-items-center">
                                <a href="@Url.Action("Index", "Libro")" class="btn btn-esparza-primary btn-sm btn-md-normal">
                                    <i class="fas fa-search me-1 me-md-2"></i>
                                    <span class="btn-text">Buscar en Catálogo</span>
                                </a>
                                <a href="@Url.Action("Index", "Prestamos")" class="btn btn-library btn-sm btn-md-normal">
                                    <i class="fas fa-hand-holding me-1 me-md-2"></i>
                                    <span class="btn-text">Nuevo Préstamo</span>
                                </a>
                                <a href="@Url.Action("Index", "Usuario")" class="btn btn-esparza-outline btn-sm btn-md-normal">
                                    <i class="fas fa-user-plus me-1 me-md-2"></i>
                                    <span class="btn-text">Registrar Usuario</span>
                                </a>
                                <a href="@Url.Action("Index", "Reservas")" class="btn btn-esparza-outline btn-sm btn-md-normal">
                                    <i class="fas fa-bookmark me-1 me-md-2"></i>
                                    <span class="btn-text">Gestionar Reservas</span>
                                </a>
                                <a href="@Url.Action("Index", "GestionBibliografica")" class="btn btn-esparza-outline btn-sm btn-md-normal">
                                    <i class="fas fa-book me-1 me-md-2"></i>
                                    <span class="btn-text">Gestión Bibliográfica</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Datos desde el modelo
            const estadisticas = @Html.Raw(Json.Serialize(estadisticas));

            if (estadisticas) {
                crearGraficoEstadoLibros(estadisticas);
                crearGraficoPrestamosDia(estadisticas.prestamosPorDia);
            }
        });

        function crearGraficoEstadoLibros(data) {
            const ctx = document.getElementById('estadoLibrosChart').getContext('2d');

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Disponibles', 'Prestados'],
                    datasets: [{
                        data: [data.librosDisponibles, data.librosPrestados],
                        backgroundColor: ['#4BC0C0', '#FF6384'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function crearGraficoPrestamosDia(datosPorDia) {
            const ctx = document.getElementById('prestamosDiaChart').getContext('2d');

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: datosPorDia.map(d => d.fecha),
                    datasets: [{
                        label: 'Préstamos por Día',
                        data: datosPorDia.map(d => d.cantidad),
                        borderColor: '#36A2EB',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // Actualizar estadísticas cada 2 minutos
        setInterval(async () => {
            try {
                const response = await fetch('/Home/RefreshEstadisticas');
                if (response.ok) {
                    location.reload();
                }
            } catch (error) {
                console.log('Error actualizando estadísticas:', error);
            }
        }, 120000);
    </script>
}